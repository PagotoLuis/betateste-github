From 41f05045ddba468738d227c5e30851dddc93f12b Mon Sep 17 00:00:00 2001
From: Joseph Sutton <josephsutton@catalyst.net.nz>
Date: Tue, 26 Oct 2021 21:05:08 +1300
Subject: [PATCH 299/361] CVE-2020-25719 tests/krb5: Return ticket from
 _tgs_req()

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14561

Signed-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
---
 python/samba/tests/krb5/kdc_tgs_tests.py | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/python/samba/tests/krb5/kdc_tgs_tests.py b/python/samba/tests/krb5/kdc_tgs_tests.py
index 480e3d8264d..11bf38766ae 100755
--- a/python/samba/tests/krb5/kdc_tgs_tests.py
+++ b/python/samba/tests/krb5/kdc_tgs_tests.py
@@ -1302,12 +1302,18 @@ class KdcTgsTests(KDCBaseTest):
             expect_edata=False,
             expect_claims=expect_claims)
 
-        self._generic_kdc_exchange(kdc_exchange_dict,
-                                   cname=None,
-                                   realm=srealm,
-                                   sname=sname,
-                                   etypes=etypes,
-                                   additional_tickets=additional_tickets)
+        rep = self._generic_kdc_exchange(kdc_exchange_dict,
+                                         cname=None,
+                                         realm=srealm,
+                                         sname=sname,
+                                         etypes=etypes,
+                                         additional_tickets=additional_tickets)
+        if expected_error:
+            self.check_error_rep(rep, expected_error)
+            return None
+        else:
+            self.check_reply(rep, KRB_TGS_REP)
+            return kdc_exchange_dict['rep_ticket_creds']
 
 
 if __name__ == "__main__":
-- 
2.30.2

