From 14117e08126ed6800e6ba8f8009b067099822ae1 Mon Sep 17 00:00:00 2001
From: Stefan Metzmacher <metze@samba.org>
Date: Fri, 11 Sep 2020 14:06:04 +0200
Subject: [PATCH 127/361] CVE-2020-25717 winbindd: add and use is_idmap_child()

We should avoid calling idmap_child() as much as possible.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14539

Signed-off-by: Stefan Metzmacher <metze@samba.org>
Reviewed-by: Gary Lockyer <gary@catalyst.net.nz>

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14556

(cherry picked from commit cd9a9702c1f97c47bd3447e2014eeff3e56268cf)
---
 source3/winbindd/winbindd_dual.c  | 4 ++--
 source3/winbindd/winbindd_idmap.c | 9 +++++++++
 source3/winbindd/winbindd_proto.h | 1 +
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/source3/winbindd/winbindd_dual.c b/source3/winbindd/winbindd_dual.c
index 0edfc2d205d..4f07ff49445 100644
--- a/source3/winbindd/winbindd_dual.c
+++ b/source3/winbindd/winbindd_dual.c
@@ -1776,7 +1776,7 @@ static bool fork_domain_child(struct winbindd_child *child)
 
 	if (child_domain != NULL) {
 		setproctitle("domain child [%s]", child_domain->name);
-	} else if (child == idmap_child()) {
+	} else if (is_idmap_child(child)) {
 		setproctitle("idmap child");
 	}
 
@@ -1826,7 +1826,7 @@ static bool fork_domain_child(struct winbindd_child *child)
 	 * We are in idmap child, make sure that we set the
 	 * check_online_event to bring primary domain online.
 	 */
-	if (child == idmap_child()) {
+	if (is_idmap_child(child)) {
 		set_domain_online_request(primary_domain);
 	}
 
diff --git a/source3/winbindd/winbindd_idmap.c b/source3/winbindd/winbindd_idmap.c
index 965a7839f17..bd5f3a67aad 100644
--- a/source3/winbindd/winbindd_idmap.c
+++ b/source3/winbindd/winbindd_idmap.c
@@ -34,6 +34,15 @@ struct winbindd_child *idmap_child(void)
 	return &static_idmap_child;
 }
 
+bool is_idmap_child(const struct winbindd_child *child)
+{
+	if (child == &static_idmap_child) {
+		return true;
+	}
+
+	return false;
+}
+
 pid_t idmap_child_pid(void)
 {
 	return static_idmap_child.pid;
diff --git a/source3/winbindd/winbindd_proto.h b/source3/winbindd/winbindd_proto.h
index ce391ab7ec5..97c38018aac 100644
--- a/source3/winbindd/winbindd_proto.h
+++ b/source3/winbindd/winbindd_proto.h
@@ -366,6 +366,7 @@ NTSTATUS winbindd_print_groupmembers(struct db_context *members,
 
 void init_idmap_child(void);
 struct winbindd_child *idmap_child(void);
+bool is_idmap_child(const struct winbindd_child *child);
 pid_t idmap_child_pid(void);
 struct dcerpc_binding_handle *idmap_child_handle(void);
 struct idmap_domain *idmap_find_domain_with_sid(const char *domname,
-- 
2.30.2

