From cb71953274dc37cb1b91814c8d8a8005da82ee78 Mon Sep 17 00:00:00 2001
From: Stefan Metzmacher <metze@samba.org>
Date: Fri, 11 Sep 2020 13:52:17 +0200
Subject: [PATCH 131/361] CVE-2020-25717 wb_queryuser: explain why
 wb_parent_idmap_setup_send/recv is not needed

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14539

Signed-off-by: Stefan Metzmacher <metze@samba.org>
Reviewed-by: Gary Lockyer <gary@catalyst.net.nz>

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14556

(cherry picked from commit 82fd07793f065e150729848566e7c30f4f4d472e)
---
 source3/winbindd/wb_queryuser.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/source3/winbindd/wb_queryuser.c b/source3/winbindd/wb_queryuser.c
index 2e36643454b..9db51909c02 100644
--- a/source3/winbindd/wb_queryuser.c
+++ b/source3/winbindd/wb_queryuser.c
@@ -138,6 +138,11 @@ static void wb_queryuser_got_uid(struct tevent_req *subreq)
 		return;
 	}
 
+	/*
+	 * Note wb_sids2xids_send/recv was called before,
+	 * so we're sure that wb_parent_idmap_setup_send/recv
+	 * was already called.
+	 */
 	child_binding_handle = idmap_child_handle();
 	subreq = dcerpc_wbint_GetNssInfo_send(
 		state, state->ev, child_binding_handle, info);
@@ -185,6 +190,11 @@ static void wb_queryuser_got_domain(struct tevent_req *subreq)
 		return;
 	}
 
+	/*
+	 * Note wb_sids2xids_send/recv was called before,
+	 * so we're sure that wb_parent_idmap_setup_send/recv
+	 * was already called.
+	 */
 	child_binding_handle = idmap_child_handle();
 	subreq = dcerpc_wbint_GetNssInfo_send(
 		state, state->ev, child_binding_handle, info);
@@ -284,6 +294,11 @@ static void wb_queryuser_got_dc(struct tevent_req *subreq)
 		return;
 	}
 
+	/*
+	 * Note wb_sids2xids_send/recv was called before,
+	 * so we're sure that wb_parent_idmap_setup_send/recv
+	 * was already called.
+	 */
 	child_binding_handle = idmap_child_handle();
 	subreq = dcerpc_wbint_GetNssInfo_send(
 		state, state->ev, child_binding_handle, info);
-- 
2.30.2

