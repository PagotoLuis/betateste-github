From fd959e61b8dda1975bbea06760f92876704c29d4 Mon Sep 17 00:00:00 2001
From: Joseph Sutton <josephsutton@catalyst.net.nz>
Date: Mon, 18 Oct 2021 15:00:38 +1300
Subject: [PATCH 201/361] CVE-2020-25719 CVE-2020-25717 tests/krb5: Add
 pac_request parameter to get_service_ticket()

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14799
BUG: https://bugzilla.samba.org/show_bug.cgi?id=14561

Signed-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
---
 python/samba/tests/krb5/kdc_base_test.py | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/python/samba/tests/krb5/kdc_base_test.py b/python/samba/tests/krb5/kdc_base_test.py
index c129883e7cd..813af767dbd 100644
--- a/python/samba/tests/krb5/kdc_base_test.py
+++ b/python/samba/tests/krb5/kdc_base_test.py
@@ -1273,10 +1273,11 @@ class KDCBaseTest(RawKerberosTest):
     def get_service_ticket(self, tgt, target_creds, service='host',
                            to_rodc=False, kdc_options=None,
                            expected_flags=None, unexpected_flags=None,
-                           fresh=False):
+                           pac_request=True, expect_pac=True, fresh=False):
         user_name = tgt.cname['name-string'][0]
         target_name = target_creds.get_username()[:-1]
-        cache_key = (user_name, target_name, service, to_rodc, kdc_options)
+        cache_key = (user_name, target_name, service, to_rodc, kdc_options,
+                     pac_request)
 
         if not fresh:
             ticket = self.tkt_cache.get(cache_key)
@@ -1312,6 +1313,8 @@ class KDCBaseTest(RawKerberosTest):
             tgt=tgt,
             authenticator_subkey=authenticator_subkey,
             kdc_options=kdc_options,
+            pac_request=pac_request,
+            expect_pac=expect_pac,
             to_rodc=to_rodc)
 
         rep = self._generic_kdc_exchange(kdc_exchange_dict,
@@ -1329,6 +1332,7 @@ class KDCBaseTest(RawKerberosTest):
             krbtgt_creds = self.get_krbtgt_creds()
         krbtgt_key = self.TicketDecryptionKey_from_creds(krbtgt_creds)
         self.verify_ticket(service_ticket_creds, krbtgt_key,
+                           expect_pac=expect_pac,
                            expect_ticket_checksum=self.tkt_sig_support)
 
         self.tkt_cache[cache_key] = service_ticket_creds
-- 
2.30.2

