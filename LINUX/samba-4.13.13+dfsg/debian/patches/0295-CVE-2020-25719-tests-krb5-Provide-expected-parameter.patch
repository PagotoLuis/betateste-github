From 68e4019339c5b4343dbd0526b411ce33c3b1d0dd Mon Sep 17 00:00:00 2001
From: Joseph Sutton <josephsutton@catalyst.net.nz>
Date: Tue, 26 Oct 2021 20:44:45 +1300
Subject: [PATCH 295/361] CVE-2020-25719 tests/krb5: Provide expected
 parameters for both AS-REQs in get_tgt()

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14561

Signed-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
---
 python/samba/tests/krb5/kdc_base_test.py | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/python/samba/tests/krb5/kdc_base_test.py b/python/samba/tests/krb5/kdc_base_test.py
index 9be6cbab30b..6d6dcc21607 100644
--- a/python/samba/tests/krb5/kdc_base_test.py
+++ b/python/samba/tests/krb5/kdc_base_test.py
@@ -1389,6 +1389,8 @@ class KDCBaseTest(RawKerberosTest):
         ticket_decryption_key = (
             self.TicketDecryptionKey_from_creds(krbtgt_creds))
 
+        expected_etypes = krbtgt_creds.tgs_supported_enctypes
+
         if kdc_options is None:
             kdc_options = ('forwardable,'
                            'renewable,'
@@ -1415,6 +1417,7 @@ class KDCBaseTest(RawKerberosTest):
             expected_salt=salt,
             expected_flags=expected_flags,
             unexpected_flags=unexpected_flags,
+            expected_supported_etypes=expected_etypes,
             etypes=etype,
             padata=None,
             kdc_options=kdc_options,
@@ -1422,6 +1425,7 @@ class KDCBaseTest(RawKerberosTest):
             ticket_decryption_key=ticket_decryption_key,
             pac_request=pac_request,
             pac_options=pac_options,
+            expect_pac=expect_pac,
             to_rodc=to_rodc)
         self.check_pre_authentication(rep)
 
@@ -1440,8 +1444,6 @@ class KDCBaseTest(RawKerberosTest):
         expected_sname = self.PrincipalName_create(
             name_type=NT_SRV_INST, names=['krbtgt', realm.upper()])
 
-        expected_etypes = krbtgt_creds.tgs_supported_enctypes
-
         rep, kdc_exchange_dict = self._test_as_exchange(
             cname=cname,
             realm=realm,
@@ -1453,6 +1455,9 @@ class KDCBaseTest(RawKerberosTest):
             expected_cname=cname,
             expected_srealm=expected_realm,
             expected_sname=expected_sname,
+            expected_account_name=expected_account_name,
+            expected_upn_name=expected_upn_name,
+            expected_sid=expected_sid,
             expected_salt=salt,
             expected_flags=expected_flags,
             unexpected_flags=unexpected_flags,
-- 
2.30.2

