From 3ef5e565b9f3a4b5a4047816029878926f91d5d7 Mon Sep 17 00:00:00 2001
From: Andrew Bartlett <abartlet@samba.org>
Date: Thu, 21 Oct 2021 15:06:14 +1300
Subject: [PATCH 191/361] CVE-2020-25722 selftest: Adjust sam.py
 test_userAccountControl_computer_add_trust to new reality

We now enforce that a trust account must be a user.

These can not be added over LDAP anyway, and our C
code in the RPC server gets this right in any case.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14753

Signed-off-by: Andrew Bartlett <abartlet@samba.org>
Reviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>
---
 selftest/knownfail.d/uac_objectclass_restrict | 1 -
 source4/dsdb/tests/python/sam.py              | 2 +-
 2 files changed, 1 insertion(+), 2 deletions(-)

diff --git a/selftest/knownfail.d/uac_objectclass_restrict b/selftest/knownfail.d/uac_objectclass_restrict
index ac7befffb1b..0fc2f4d47a2 100644
--- a/selftest/knownfail.d/uac_objectclass_restrict
+++ b/selftest/knownfail.d/uac_objectclass_restrict
@@ -4,7 +4,6 @@
 # All these tests need to be fixed and the entries here removed
 
 ^samba4.sam.python\(.*\).__main__.SamTests.test_userAccountControl_computer_add_0_uac
-^samba4.sam.python\(.*\).__main__.SamTests.test_userAccountControl_computer_add_trust
 ^samba4.sam.python\(.*\).__main__.SamTests.test_userAccountControl_computer_modify
 ^samba4.sam.python\(.*\).__main__.SamTests.test_userAccountControl_user_modify
 ^samba4.sam.python\(fl2008r2dc\).__main__.SamTests.test_users_groups\(fl2008r2dc\)
diff --git a/source4/dsdb/tests/python/sam.py b/source4/dsdb/tests/python/sam.py
index 077a1a86e90..ae83a136785 100755
--- a/source4/dsdb/tests/python/sam.py
+++ b/source4/dsdb/tests/python/sam.py
@@ -2299,7 +2299,7 @@ class SamTests(samba.tests.TestCase):
             self.fail()
         except LdbError as e72:
             (num, _) = e72.args
-            self.assertEqual(num, ERR_INSUFFICIENT_ACCESS_RIGHTS)
+            self.assertEqual(num, ERR_OBJECT_CLASS_VIOLATION)
         delete_force(self.ldb, "cn=ldaptestcomputer,cn=computers," + self.base_dn)
 
     def test_userAccountControl_computer_modify(self):
-- 
2.30.2

