From f951228a7613622522202239ce0f27f7214bd176 Mon Sep 17 00:00:00 2001
From: Stefan Metzmacher <metze@samba.org>
Date: Thu, 21 Mar 2019 12:30:37 +0100
Subject: [PATCH 121/361] CVE-2020-25717 winbindd/idmap: apply const to struct
 idmap_methods pointers

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14539

Signed-off-by: Stefan Metzmacher <metze@samba.org>
Reviewed-by: Gary Lockyer <gary@catalyst.net.nz>

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14556

(cherry picked from commit 95b0dac0af5bc7ee85c6c8099dda135c36c9684b)
---
 source3/include/idmap.h                  | 2 +-
 source3/winbindd/idmap.c                 | 6 +++---
 source3/winbindd/idmap_ad.c              | 2 +-
 source3/winbindd/idmap_autorid.c         | 2 +-
 source3/winbindd/idmap_hash/idmap_hash.c | 2 +-
 source3/winbindd/idmap_ldap.c            | 2 +-
 source3/winbindd/idmap_nss.c             | 3 +--
 source3/winbindd/idmap_passdb.c          | 7 +------
 source3/winbindd/idmap_proto.h           | 2 +-
 source3/winbindd/idmap_rfc2307.c         | 2 +-
 source3/winbindd/idmap_rid.c             | 2 +-
 source3/winbindd/idmap_script.c          | 2 +-
 source3/winbindd/idmap_tdb.c             | 2 +-
 source3/winbindd/idmap_tdb2.c            | 2 +-
 14 files changed, 16 insertions(+), 22 deletions(-)

diff --git a/source3/include/idmap.h b/source3/include/idmap.h
index 8d80643e6e9..dce60f1f76d 100644
--- a/source3/include/idmap.h
+++ b/source3/include/idmap.h
@@ -42,7 +42,7 @@ struct idmap_domain {
 	 * so don't rely on this being filled out everywhere!
 	 */
 	struct dom_sid dom_sid;
-	struct idmap_methods *methods;
+	const struct idmap_methods *methods;
 	NTSTATUS (*query_user)(struct idmap_domain *domain,
 			       struct wbint_userinfo *info);
 	uint32_t low_id;
diff --git a/source3/winbindd/idmap.c b/source3/winbindd/idmap.c
index bfac7f86432..eee28992929 100644
--- a/source3/winbindd/idmap.c
+++ b/source3/winbindd/idmap.c
@@ -40,7 +40,7 @@ static_decl_idmap;
 
 struct idmap_backend {
 	const char *name;
-	struct idmap_methods *methods;
+	const struct idmap_methods *methods;
 	struct idmap_backend *prev, *next;
 };
 static struct idmap_backend *backends = NULL;
@@ -285,7 +285,7 @@ static bool idmap_found_domain_backend(const char *domname,
 	return false;
 }
 
-static struct idmap_methods *get_methods(const char *name)
+static const struct idmap_methods *get_methods(const char *name)
 {
 	struct idmap_backend *b;
 
@@ -309,7 +309,7 @@ bool idmap_is_offline(void)
 **********************************************************************/
 
 NTSTATUS smb_register_idmap(int version, const char *name,
-			    struct idmap_methods *methods)
+			    const struct idmap_methods *methods)
 {
 	struct idmap_backend *entry;
 
diff --git a/source3/winbindd/idmap_ad.c b/source3/winbindd/idmap_ad.c
index 3bfeeee2d74..5cd258d49c4 100644
--- a/source3/winbindd/idmap_ad.c
+++ b/source3/winbindd/idmap_ad.c
@@ -1003,7 +1003,7 @@ static NTSTATUS idmap_ad_sids_to_unixids_retry(struct idmap_domain *dom,
 	return status;
 }
 
-static struct idmap_methods ad_methods = {
+static const struct idmap_methods ad_methods = {
 	.init            = idmap_ad_initialize,
 	.unixids_to_sids = idmap_ad_unixids_to_sids_retry,
 	.sids_to_unixids = idmap_ad_sids_to_unixids_retry,
diff --git a/source3/winbindd/idmap_autorid.c b/source3/winbindd/idmap_autorid.c
index 1d0f0fafb82..636852119b2 100644
--- a/source3/winbindd/idmap_autorid.c
+++ b/source3/winbindd/idmap_autorid.c
@@ -919,7 +919,7 @@ done:
 	return status;
 }
 
-static struct idmap_methods autorid_methods = {
+static const struct idmap_methods autorid_methods = {
 	.init = idmap_autorid_initialize,
 	.unixids_to_sids = idmap_autorid_unixids_to_sids,
 	.sids_to_unixids = idmap_autorid_sids_to_unixids,
diff --git a/source3/winbindd/idmap_hash/idmap_hash.c b/source3/winbindd/idmap_hash/idmap_hash.c
index 1747b7c56c1..267ff3e5edc 100644
--- a/source3/winbindd/idmap_hash/idmap_hash.c
+++ b/source3/winbindd/idmap_hash/idmap_hash.c
@@ -331,7 +331,7 @@ static NTSTATUS nss_hash_close(void)
  Dispatch Tables for IDMap and NssInfo Methods
 ********************************************************************/
 
-static struct idmap_methods hash_idmap_methods = {
+static const struct idmap_methods hash_idmap_methods = {
 	.init            = idmap_hash_initialize,
 	.unixids_to_sids = unixids_to_sids,
 	.sids_to_unixids = sids_to_unixids,
diff --git a/source3/winbindd/idmap_ldap.c b/source3/winbindd/idmap_ldap.c
index 86cb6f1bc51..82f425ec9d0 100644
--- a/source3/winbindd/idmap_ldap.c
+++ b/source3/winbindd/idmap_ldap.c
@@ -1093,7 +1093,7 @@ done:
  Close the idmap ldap instance
 **********************************/
 
-static struct idmap_methods idmap_ldap_methods = {
+static const struct idmap_methods idmap_ldap_methods = {
 
 	.init = idmap_ldap_db_init,
 	.unixids_to_sids = idmap_ldap_unixids_to_sids,
diff --git a/source3/winbindd/idmap_nss.c b/source3/winbindd/idmap_nss.c
index 16f5a74bc0f..da50e2b4aa7 100644
--- a/source3/winbindd/idmap_nss.c
+++ b/source3/winbindd/idmap_nss.c
@@ -199,8 +199,7 @@ static NTSTATUS idmap_nss_sids_to_unixids(struct idmap_domain *dom, struct id_ma
  Close the idmap tdb instance
 **********************************/
 
-static struct idmap_methods nss_methods = {
-
+static const struct idmap_methods nss_methods = {
 	.init = idmap_nss_int_init,
 	.unixids_to_sids = idmap_nss_unixids_to_sids,
 	.sids_to_unixids = idmap_nss_sids_to_unixids,
diff --git a/source3/winbindd/idmap_passdb.c b/source3/winbindd/idmap_passdb.c
index 75fc732cca0..758f31a2c9d 100644
--- a/source3/winbindd/idmap_passdb.c
+++ b/source3/winbindd/idmap_passdb.c
@@ -75,12 +75,7 @@ static NTSTATUS idmap_pdb_sids_to_unixids(struct idmap_domain *dom, struct id_ma
 	return NT_STATUS_OK;
 }
 
-/**********************************
- Close the idmap tdb instance
-**********************************/
-
-static struct idmap_methods passdb_methods = {
-
+static const struct idmap_methods passdb_methods = {
 	.init = idmap_pdb_init,
 	.unixids_to_sids = idmap_pdb_unixids_to_sids,
 	.sids_to_unixids = idmap_pdb_sids_to_unixids,
diff --git a/source3/winbindd/idmap_proto.h b/source3/winbindd/idmap_proto.h
index a36d6c2f5bb..adc04430a67 100644
--- a/source3/winbindd/idmap_proto.h
+++ b/source3/winbindd/idmap_proto.h
@@ -29,7 +29,7 @@
 
 bool idmap_is_offline(void);
 NTSTATUS smb_register_idmap(int version, const char *name,
-			    struct idmap_methods *methods);
+			    const struct idmap_methods *methods);
 void idmap_close(void);
 NTSTATUS idmap_allocate_uid(struct unixid *id);
 NTSTATUS idmap_allocate_gid(struct unixid *id);
diff --git a/source3/winbindd/idmap_rfc2307.c b/source3/winbindd/idmap_rfc2307.c
index 2fffaec6cca..b8e478907e9 100644
--- a/source3/winbindd/idmap_rfc2307.c
+++ b/source3/winbindd/idmap_rfc2307.c
@@ -838,7 +838,7 @@ err:
 	return status;
 }
 
-static struct idmap_methods rfc2307_methods = {
+static const struct idmap_methods rfc2307_methods = {
 	.init = idmap_rfc2307_initialize,
 	.unixids_to_sids = idmap_rfc2307_unixids_to_sids,
 	.sids_to_unixids = idmap_rfc2307_sids_to_unixids,
diff --git a/source3/winbindd/idmap_rid.c b/source3/winbindd/idmap_rid.c
index e5bb1fa856c..33f049695f4 100644
--- a/source3/winbindd/idmap_rid.c
+++ b/source3/winbindd/idmap_rid.c
@@ -168,7 +168,7 @@ static NTSTATUS idmap_rid_sids_to_unixids(struct idmap_domain *dom, struct id_ma
 	return NT_STATUS_OK;
 }
 
-static struct idmap_methods rid_methods = {
+static const struct idmap_methods rid_methods = {
 	.init = idmap_rid_initialize,
 	.unixids_to_sids = idmap_rid_unixids_to_sids,
 	.sids_to_unixids = idmap_rid_sids_to_unixids,
diff --git a/source3/winbindd/idmap_script.c b/source3/winbindd/idmap_script.c
index f382f896b35..a56ad7b93fb 100644
--- a/source3/winbindd/idmap_script.c
+++ b/source3/winbindd/idmap_script.c
@@ -665,7 +665,7 @@ failed:
 	return ret;
 }
 
-static struct idmap_methods db_methods = {
+static const struct idmap_methods db_methods = {
 	.init            = idmap_script_db_init,
 	.unixids_to_sids = idmap_script_unixids_to_sids,
 	.sids_to_unixids = idmap_script_sids_to_unixids,
diff --git a/source3/winbindd/idmap_tdb.c b/source3/winbindd/idmap_tdb.c
index c3215c4dd9b..1ec2be0d789 100644
--- a/source3/winbindd/idmap_tdb.c
+++ b/source3/winbindd/idmap_tdb.c
@@ -426,7 +426,7 @@ failed:
 	return ret;
 }
 
-static struct idmap_methods db_methods = {
+static const struct idmap_methods db_methods = {
 	.init = idmap_tdb_db_init,
 	.unixids_to_sids = idmap_tdb_common_unixids_to_sids,
 	.sids_to_unixids = idmap_tdb_common_sids_to_unixids,
diff --git a/source3/winbindd/idmap_tdb2.c b/source3/winbindd/idmap_tdb2.c
index eceab9c0784..f2731f9a04a 100644
--- a/source3/winbindd/idmap_tdb2.c
+++ b/source3/winbindd/idmap_tdb2.c
@@ -598,7 +598,7 @@ failed:
 }
 
 
-static struct idmap_methods db_methods = {
+static const struct idmap_methods db_methods = {
 	.init            = idmap_tdb2_db_init,
 	.unixids_to_sids = idmap_tdb_common_unixids_to_sids,
 	.sids_to_unixids = idmap_tdb_common_sids_to_unixids,
-- 
2.30.2

