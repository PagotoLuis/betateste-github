From 3a4d785ff923d9c06cec9a92b273aa4f93e850cb Mon Sep 17 00:00:00 2001
From: Stefan Metzmacher <metze@samba.org>
Date: Thu, 10 Sep 2020 23:06:02 +0200
Subject: [PATCH 142/361] CVE-2020-25717 wb_sids2xids: fill cache as soon as
 possible

After adding entries to the cache we can mark them
as filled from the cache by setting its domain_index
to UINT32_MAX.

This will allow further changes to fill the results
into state->all_ids in steps.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14539

Signed-off-by: Stefan Metzmacher <metze@samba.org>
Reviewed-by: Gary Lockyer <gary@catalyst.net.nz>

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14556

(cherry picked from commit 3f4626ea6d235470195918b77af35ac2cfeb227c)
---
 source3/winbindd/wb_sids2xids.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/source3/winbindd/wb_sids2xids.c b/source3/winbindd/wb_sids2xids.c
index cdbc70a0b49..21bf5f901f3 100644
--- a/source3/winbindd/wb_sids2xids.c
+++ b/source3/winbindd/wb_sids2xids.c
@@ -455,6 +455,8 @@ static void wb_sids2xids_done(struct tevent_req *subreq)
 		if (src->ids[si].xid.type != ID_TYPE_NOT_SPECIFIED) {
 			dst->ids[di].xid  = src->ids[si].xid;
 		}
+		dst->ids[di].domain_index = UINT32_MAX; /* mark as valid */
+		idmap_cache_set_sid2unixid(&state->sids[di], &dst->ids[di].xid);
 	}
 
 	state->map_ids_in.num_ids = 0;
@@ -547,9 +549,6 @@ NTSTATUS wb_sids2xids_recv(struct tevent_req *req,
 
 	for (i=0; i<state->num_sids; i++) {
 		xids[i] = state->all_ids.ids[i].xid;
-		if (state->all_ids.ids[i].domain_index != UINT32_MAX) {
-			idmap_cache_set_sid2unixid(&state->sids[i], &xids[i]);
-		}
 	}
 
 	return NT_STATUS_OK;
-- 
2.30.2

